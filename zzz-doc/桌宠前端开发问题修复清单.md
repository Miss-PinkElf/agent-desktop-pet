# 桌宠前端开发问题修复清单
（注意一下模型的大小，和窗口的大小，需要居中）
## 一、核心依赖版本兼容性问题（最关键）

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `@vitejs/plugin-react` ESM 错误 | 该插件是 ESM only，但 vite 配置使用 CommonJS | 将 `vite.renderer.config.ts` 改为 `vite.renderer.config.mts` |
| `manager.on is not a function` | pixi.js v7 与 pixi-live2d-display@0.4.0 不兼容 | **降级 pixi.js 到 v6** |
| `currentTarget.isInteractive is not a function` | PIXI v7 事件系统与 live2d 插件冲突 | 使用 **pixi.js@6** 版本 |
| `Could not find Cubism 2 runtime` | pixi-live2d-display 默认加载 Cubism 2 | 从 `pixi-live2d-display/cubism4` 导入 |

**最终稳定版本组合：**
```json
{
  "pixi.js": "6.x",
  "pixi-live2d-display": "0.4.0"
}
```

---

## 二、配置文件修改

| 文件 | 修改内容 |
|------|----------|
| `forge.config.ts` | vite 配置引用从 `.ts` 改为 `.mts` |
| `vite.renderer.config.mts` | 新建 ESM 格式配置，添加 React 插件 |
| `tsconfig.json` | 添加 `"jsx": "react-jsx"` |
| `index.html` | 引入 `live2dcubismcore.js`，添加 `<div id="root">` |

---

## 三、代码层面的关键修复

### 1. Live2D 模型加载 (`useLive2DModel.ts`)

```typescript
// 关键：必须从 /cubism4 路径导入，否则会尝试加载 Cubism 2
import { Live2DModel } from 'pixi-live2d-display/cubism4';

// 必须注册 Ticker
Live2DModel.registerTicker(PIXI.Ticker);
```

### 2. PIXI Application 初始化 (`Live2DCanvas.tsx`)

```typescript
// PIXI v6 同步初始化方式
const app = new PIXI.Application({
  view: canvasRef.current,
  width: 400,
  height: 500,
  backgroundAlpha: 0,
  resolution: window.devicePixelRatio || 1,
  autoDensity: true,
});
```

### 3. React 集成注意事项

- 移除 `React.StrictMode`（避免双重渲染导致 PIXI canvas 冲突）
- 使用 `useRef` 防止重复初始化
- 正确处理 cleanup 函数

---

## 四、Electron 透明窗口配置 (`main.ts`)

```typescript
const mainWindow = new BrowserWindow({
  width: 400,
  height: 500,
  transparent: true,      // 透明背景
  frame: false,           // 无边框
  alwaysOnTop: true,      // 始终置顶
  hasShadow: false,       // 无阴影
  resizable: false,
  webPreferences: {
    webSecurity: false,   // 允许加载本地文件（重要！）
  },
});
```

---

## 五、文件结构

```
frontend/src/
├── components/
│   └── Live2DWidget/
│       ├── index.tsx              # 主组件
│       ├── index.scss             # 组件样式
│       ├── Live2DCanvas.tsx       # PIXI Canvas 初始化
│       ├── useLive2DModel.ts      # 模型加载 Hook（关键：/cubism4 导入）
│       └── useRandomExpression.ts # 随机表情 Hook
├── styles/
│   └── global.scss                # 全局样式（透明背景）
├── utils/
│   └── expressionManager.ts       # 表情管理
├── App.tsx                        # 根组件
├── App.module.scss                # CSS Module 样式
├── main.tsx                       # React 入口（无 StrictMode）
└── vite-env.d.ts                  # 类型声明（含 Live2DCubismCore）
```

---

## 六、关键教训总结

1. **版本兼容性最重要**：pixi.js 和 pixi-live2d-display 必须使用兼容的版本组合
2. **Cubism 版本要匹配**：使用 moc3 模型必须从 `/cubism4` 路径导入
3. **ESM/CJS 混用要注意**：Vite 插件配置文件需要正确的模块格式
4. **React + PIXI 注意事项**：避免 StrictMode，正确管理生命周期

---

## 七、安装依赖命令

```bash
cd frontend

# React 相关
npm install react react-dom
npm install -D @types/react @types/react-dom @vitejs/plugin-react

# Live2D 渲染（注意版本）
npm install pixi.js@6 pixi-live2d-display

# 样式
npm install -D sass
```

---

## 八、开发命令

```bash
cd frontend
npm install    # 安装依赖
npm start      # 开发模式运行
```

---

## 九、React + PIXI 状态同步问题（模型不显示）

### 问题描述
模型加载代码没有报错，但模型不显示在窗口中。

### 原因分析

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `useLive2DModel` hook 始终收到 `app=null` | `useRef` 修改值不会触发 React 重新渲染，hook 无法感知 PIXI Application 已初始化 | 改用 `useState` 存储 app 实例 |
| 模型路径 404 | `models` 目录不在 Vite 静态资源路径中 | 配置 `publicDir: 'models'` |
| 模型路径需要调整 | 配置 `publicDir` 后，目录内容会被复制到根路径 | 路径从 `/models/jk-cat/...` 改为 `/jk-cat/...` |

### 修复代码

#### 1. Live2DCanvas.tsx - 使用 useState 替代 useRef

```typescript
// ❌ 错误：useRef 不会触发重新渲染
const appRef = useRef<PIXI.Application | null>(null);
const { model } = useLive2DModel(appRef.current); // 始终是 null

useEffect(() => {
  const app = new PIXI.Application({ ... });
  appRef.current = app; // 不触发重新渲染
}, []);

// ✅ 正确：使用 useState 触发重新渲染
const [app, setApp] = useState<PIXI.Application | null>(null);
const { model } = useLive2DModel(app); // app 更新后会重新执行

useEffect(() => {
  const pixiApp = new PIXI.Application({ ... });
  setApp(pixiApp); // 触发重新渲染
}, []);
```

#### 2. vite.renderer.config.mts - 配置静态资源目录

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  publicDir: 'models',  // 将 models 目录作为静态资源目录
});
```

#### 3. useLive2DModel.ts - 调整模型路径

```typescript
// ❌ 错误：配置 publicDir 前的路径
const live2dModel = await Live2DModel.from('/models/jk-cat/jk盐.model3.json');

// ✅ 正确：配置 publicDir 后的路径
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json');
```

### 调试技巧

在关键位置添加日志，帮助定位问题：

```typescript
// Live2DCanvas.tsx
console.log('PIXI Application created');
setApp(pixiApp);

// useLive2DModel.ts
console.log('Loading Live2D model...');
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json');
console.log('Model loaded:', live2dModel);
app.stage.addChild(live2dModel);
console.log('Model added to stage');
```

---

## 十、模型居中显示

### 问题
模型显示位置不正确，可能超出窗口或不在中心。

### 解决方案

```typescript
// 设置锚点在模型中心
live2dModel.anchor.set(0.5, 0.5);

// 计算缩放比例，适应窗口大小
const scale = Math.min(
  app.screen.width / live2dModel.width,
  app.screen.height / live2dModel.height
);
live2dModel.scale.set(scale * 0.9);  // 0.9 留一点边距

// 居中定位
live2dModel.x = app.screen.width / 2;
live2dModel.y = app.screen.height / 2;
```

---

## 十一、模型模糊/不清晰问题

### 问题描述
模型显示模糊，看起来不清晰。

### 原因分析

| 原因 | 说明 |
|------|------|
| 高 DPI 显示器 | 需要提高渲染分辨率 |
| 窗口尺寸太小 | 模型被过度缩小导致模糊 |
| 抗锯齿未启用 | 边缘可能模糊 |

### 解决方案

#### 1. 提高渲染分辨率

```typescript
// Live2DCanvas.tsx
const pixiApp = new PIXI.Application({
  view: canvasRef.current,
  width,
  height,
  backgroundAlpha: 0,
  resolution: window.devicePixelRatio * 2 || 2,  // 提高 2 倍分辨率
  autoDensity: true,
  antialias: true,  // 启用抗锯齿
});
```

#### 2. 增大窗口尺寸

窗口太小会导致高清模型被缩小显示，看起来模糊。

```typescript
// main.ts
const mainWindow = new BrowserWindow({
  width: 600,   // 原 400
  height: 750,  // 原 500
  // ...
});

// Live2DCanvas.tsx
export function Live2DCanvas({ width = 600, height = 750 }: Live2DCanvasProps) {
  // ...
}
```

#### 3. 模型加载优化

```typescript
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json', {
  autoInteract: false,  // 禁用自动交互，提高性能
});
```

### 注意事项

- 模型纹理越大，渲染越消耗 GPU 资源
- 分辨率倍数过高可能导致性能问题
- 需要在清晰度和性能之间权衡

---

## 十二、模型不跟随鼠标问题

### 问题描述
模型眼睛/头部不再跟随鼠标移动。

### 原因
在 `Live2DModel.from()` 中设置了 `autoInteract: false`，禁用了自动交互功能。

```typescript
// ❌ 错误：禁用了鼠标跟随
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json', {
  autoInteract: false,
});
```

### 解决方案
移除该选项，或设置为 `true`（默认值）：

```typescript
// ✅ 正确：保持默认交互行为
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json');
```
