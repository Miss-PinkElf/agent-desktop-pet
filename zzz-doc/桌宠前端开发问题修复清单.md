# 桌宠前端开发问题修复清单
（注意一下模型的大小，和窗口的大小，需要居中）
## 一、核心依赖版本兼容性问题（最关键）

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `@vitejs/plugin-react` ESM 错误 | 该插件是 ESM only，但 vite 配置使用 CommonJS | 将 `vite.renderer.config.ts` 改为 `vite.renderer.config.mts` |
| `manager.on is not a function` | pixi.js v7 与 pixi-live2d-display@0.4.0 不兼容 | **降级 pixi.js 到 v6** |
| `currentTarget.isInteractive is not a function` | PIXI v7 事件系统与 live2d 插件冲突 | 使用 **pixi.js@6** 版本 |
| `Could not find Cubism 2 runtime` | pixi-live2d-display 默认加载 Cubism 2 | 从 `pixi-live2d-display/cubism4` 导入 |

**最终稳定版本组合：**
```json
{
  "pixi.js": "6.x",
  "pixi-live2d-display": "0.4.0"
}
```

---

## 二、配置文件修改

| 文件 | 修改内容 |
|------|----------|
| `forge.config.ts` | vite 配置引用从 `.ts` 改为 `.mts` |
| `vite.renderer.config.mts` | 新建 ESM 格式配置，添加 React 插件 |
| `tsconfig.json` | 添加 `"jsx": "react-jsx"` |
| `index.html` | 引入 `live2dcubismcore.js`，添加 `<div id="root">` |

---

## 三、代码层面的关键修复

### 1. Live2D 模型加载 (`useLive2DModel.ts`)

```typescript
// 关键：必须从 /cubism4 路径导入，否则会尝试加载 Cubism 2
import { Live2DModel } from 'pixi-live2d-display/cubism4';

// 必须注册 Ticker
Live2DModel.registerTicker(PIXI.Ticker);
```

### 2. PIXI Application 初始化 (`Live2DCanvas.tsx`)

```typescript
// PIXI v6 同步初始化方式
const app = new PIXI.Application({
  view: canvasRef.current,
  width: 400,
  height: 500,
  backgroundAlpha: 0,
  resolution: window.devicePixelRatio || 1,
  autoDensity: true,
});
```

### 3. React 集成注意事项

- 移除 `React.StrictMode`（避免双重渲染导致 PIXI canvas 冲突）
- 使用 `useRef` 防止重复初始化
- 正确处理 cleanup 函数

---

## 四、Electron 透明窗口配置 (`main.ts`)

```typescript
const mainWindow = new BrowserWindow({
  width: 400,
  height: 500,
  transparent: true,      // 透明背景
  frame: false,           // 无边框
  alwaysOnTop: true,      // 始终置顶
  hasShadow: false,       // 无阴影
  resizable: false,
  webPreferences: {
    webSecurity: false,   // 允许加载本地文件（重要！）
  },
});
```

---

## 五、文件结构

```
frontend/src/
├── components/
│   └── Live2DWidget/
│       ├── index.tsx              # 主组件
│       ├── index.scss             # 组件样式
│       ├── Live2DCanvas.tsx       # PIXI Canvas 初始化
│       ├── useLive2DModel.ts      # 模型加载 Hook（关键：/cubism4 导入）
│       └── useRandomExpression.ts # 随机表情 Hook
├── styles/
│   └── global.scss                # 全局样式（透明背景）
├── utils/
│   └── expressionManager.ts       # 表情管理
├── App.tsx                        # 根组件
├── App.module.scss                # CSS Module 样式
├── main.tsx                       # React 入口（无 StrictMode）
└── vite-env.d.ts                  # 类型声明（含 Live2DCubismCore）
```

---

## 六、关键教训总结

1. **版本兼容性最重要**：pixi.js 和 pixi-live2d-display 必须使用兼容的版本组合
2. **Cubism 版本要匹配**：使用 moc3 模型必须从 `/cubism4` 路径导入
3. **ESM/CJS 混用要注意**：Vite 插件配置文件需要正确的模块格式
4. **React + PIXI 注意事项**：避免 StrictMode，正确管理生命周期

---

## 七、安装依赖命令

```bash
cd frontend

# React 相关
npm install react react-dom
npm install -D @types/react @types/react-dom @vitejs/plugin-react

# Live2D 渲染（注意版本）
npm install pixi.js@6 pixi-live2d-display

# 样式
npm install -D sass
```

---

## 八、开发命令

```bash
cd frontend
npm install    # 安装依赖
npm start      # 开发模式运行
```
