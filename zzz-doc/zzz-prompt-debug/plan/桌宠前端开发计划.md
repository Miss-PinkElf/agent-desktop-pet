# 桌宠前端开发计划

## 当前目标

实现基础桌宠功能：
- Live2D 模型展示（使用 pixi-live2d-display + moc3 格式）
- 透明背景窗口
- 鼠标拖动
- 随机播放表情

---

## 技术栈

| 类别 | 选型 |
|------|------|
| 桌面框架 | Electron |
| 前端框架 | React |
| 构建工具 | Vite |
| 包管理器 | npm |
| 语言/文件 | TypeScript + TSX |
| 样式方案 | SCSS + CSS Module（仅最外层）|
| Live2D 渲染 | pixi.js + pixi-live2d-display |
| 模型格式 | .model3.json (Live2D Cubism 3/4/5) |

---

## 样式方案说明

> **核心规则**：
> - **最外层** (`App.module.scss`)：使用 CSS Module，`className={styles.xxx}`
> - **内层组件** (`index.scss`)：与组件同级，用 `:global{}` 包裹，使用普通 className
> - **全局样式** (`global.scss`)：body、#root 等基础样式

```tsx
// App.tsx - 最外层使用 CSS Module
import styles from './App.module.scss';
<div className={styles.container}>
  <Live2DWidget />
</div>

// Live2DWidget/index.tsx - 内层使用普通 className + 导入样式
import './index.scss';
<div className="live2d-widget">
  <canvas className="live2d-canvas" />
</div>

// Live2DWidget/index.scss - 内层样式用 :global{} 包裹
:global {
  .live2d-widget { ... }
  .live2d-canvas { ... }
}
```

---

## 前置条件

Live2D Cubism SDK for Web 的 Core 文件已就位：
```
frontend/models/core/live2dcubismcore.js
```

---

## 实现步骤

### 步骤 1：安装依赖

```bash
cd frontend

# React 相关
npm install react react-dom
npm install -D @types/react @types/react-dom @vitejs/plugin-react

# Live2D 渲染
npm install pixi.js pixi-live2d-display

# 样式
npm install -D sass
```

---

### 步骤 2：修改配置文件

#### 2.1 vite.renderer.config.ts
- 添加 React 插件

#### 2.2 tsconfig.json
- 添加 JSX 支持: `"jsx": "react-jsx"`

#### 2.3 index.html
- 引入 live2dcubismcore.js
- 添加 React root 容器 `<div id="root"></div>`

---

### 步骤 3：Electron 透明窗口配置

修改 `src/main.ts`：

```typescript
const mainWindow = new BrowserWindow({
  width: 400,
  height: 500,
  transparent: true,      // 透明背景
  frame: false,           // 无边框
  alwaysOnTop: true,      // 始终置顶
  hasShadow: false,       // 无阴影
  resizable: false,
  webPreferences: {
    preload: path.join(__dirname, 'preload.js'),
    webSecurity: false,   // 允许加载本地文件
  },
});
```

---

### 步骤 4：创建目录结构

```
frontend/src/
├── components/
│   └── Live2DWidget/
│       ├── index.tsx              # 主组件
│       ├── index.scss             # 组件样式（:global{} 包裹）
│       ├── Live2DCanvas.tsx       # Canvas 渲染组件
│       ├── useLive2DModel.ts      # 模型加载 Hook
│       └── useRandomExpression.ts # 随机表情 Hook
├── styles/
│   └── global.scss                # 全局样式（body、#root 等）
├── utils/
│   └── expressionManager.ts       # 表情管理工具
├── App.tsx                        # 根组件（使用 CSS Module）
├── App.module.scss                # 最外层样式
├── main.tsx                       # React 入口
└── vite-env.d.ts                  # 类型声明
```

---

### 步骤 5：组件职责划分

| 组件/文件 | 职责 |
|-----------|------|
| `Live2DWidget/index.tsx` | 主容器，组合 Canvas 和控制逻辑 |
| `Live2DCanvas.tsx` | 负责 PIXI.js Canvas 初始化和渲染 |
| `useLive2DModel.ts` | 加载模型、管理模型实例 |
| `useRandomExpression.ts` | 随机表情定时器逻辑 |
| `expressionManager.ts` | 表情列表配置、随机选择算法 |

---

### 步骤 6：样式文件内容

#### 6.1 全局样式 (`styles/global.scss`)
```scss
:global {
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: transparent;
    margin: 0;
    overflow: hidden;
  }

  #root {
    width: 100vw;
    height: 100vh;
    background: transparent;
  }
}
```

#### 6.2 最外层样式 (`App.module.scss`)
```scss
.container {
  width: 100vw;
  height: 100vh;
  background: transparent;
}
```

#### 6.3 组件样式 (`components/Live2DWidget/index.scss`)
```scss
:global {
  .live2d-widget {
    width: 100%;
    height: 100%;
    position: relative;
    -webkit-app-region: drag;  // 允许拖动
    cursor: move;
  }

  .live2d-canvas {
    width: 100%;
    height: 100%;
  }
}
```

---

### 步骤 7：核心功能实现

#### 7.1 Live2D 模型加载 (`useLive2DModel.ts`)
```typescript
import * as PIXI from 'pixi.js';
import { Live2DModel } from 'pixi-live2d-display';

// 注册 Live2D 模型
Live2DModel.registerTicker(PIXI.Ticker);

// 加载模型
const model = await Live2DModel.from('../models/jk-cat/jk盐.model3.json');
```

#### 7.2 随机表情播放 (`useRandomExpression.ts`)
```typescript
// 表情配置
const EXPRESSIONS = [
  '脸红',
  '眼-星星眼',
  '眼-爱心眼',
  '眼-哭哭',
  '眼-生气',
  // ... 更多表情
];

// 定时随机播放（如每 5-10 秒）
setInterval(playRandomExpression, 5000 + Math.random() * 5000);
```

---

## 文件修改清单

### 需要修改的文件

| 文件 | 修改内容 |
|------|----------|
| `package.json` | 添加 React、pixi、sass 依赖 |
| `vite.renderer.config.ts` | 添加 React 插件 |
| `tsconfig.json` | 添加 JSX 配置 |
| `src/main.ts` | 透明窗口配置 |
| `index.html` | 引入 Live2D Core，添加 root 容器 |

### 需要新增的文件

| 文件 | 说明 |
|------|------|
| `src/main.tsx` | React 入口 |
| `src/App.tsx` | 根组件（使用 CSS Module） |
| `src/App.module.scss` | 最外层 CSS Module 样式 |
| `src/styles/global.scss` | 全局样式（body、#root） |
| `src/components/Live2DWidget/index.tsx` | 主组件 |
| `src/components/Live2DWidget/index.scss` | 组件样式（:global{}） |
| `src/components/Live2DWidget/Live2DCanvas.tsx` | Canvas 渲染组件 |
| `src/components/Live2DWidget/useLive2DModel.ts` | 模型加载 Hook |
| `src/components/Live2DWidget/useRandomExpression.ts` | 随机表情 Hook |
| `src/utils/expressionManager.ts` | 表情管理工具 |
| `src/vite-env.d.ts` | CSS Module 类型声明 |

---

## 可用表情列表

| 文件名 | 描述 |
|--------|------|
| 脸红.exp3.json | 脸红 |
| 眼-星星眼.exp3.json | 星星眼 |
| 眼-爱心眼.exp3.json | 爱心眼 |
| 眼-哭哭.exp3.json | 哭泣 |
| 眼-生气.exp3.json | 生气 |
| 眼-泪眼汪汪.exp3.json | 泪眼汪汪 |
| 眼-眩晕流汗.exp3.json | 眩晕流汗 |
| 吐舌.exp3.json | 吐舌 |
| 脸黑.exp3.json | 脸黑 |
| 眼-平静死鱼眼.exp3.json | 死鱼眼 |

---

## 预期效果

1. 启动后显示透明窗口，只看到 Live2D 模型
2. 模型可以通过鼠标拖动在屏幕上移动
3. 每 5-10 秒随机切换表情
4. 窗口始终置顶

---

## 开发命令

```bash
cd frontend
npm install    # 安装依赖
npm start      # 开发模式运行
```

---

## 风险与注意事项

1. **CORS 问题**：本地文件加载需要配置 `webSecurity: false`
2. **模型路径**：生产环境需正确配置资源路径
3. **性能**：Live2D 渲染需要 GPU 资源
4. **表情过渡**：`pixi-live2d-display` 会自动处理表情过渡
