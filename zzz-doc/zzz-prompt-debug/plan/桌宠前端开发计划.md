# 桌宠前端开发计划

## 当前目标

实现基础桌宠功能：
- Live2D 模型展示（使用 pixi-live2d-display + moc3 格式）
- 透明背景窗口
- 鼠标拖动
- 随机播放表情
- 模型跟随鼠标（眼睛/头部）

---

## 技术栈

| 类别 | 选型 | 版本要求 |
|------|------|----------|
| 桌面框架 | Electron | - |
| 前端框架 | React | - |
| 构建工具 | Vite | - |
| 包管理器 | npm | - |
| 语言/文件 | TypeScript + TSX | - |
| 样式方案 | SCSS + CSS Module（仅最外层）| - |
| Live2D 渲染 | pixi.js | **必须 v6**（v7 不兼容） |
| Live2D 渲染 | pixi-live2d-display | **0.4.0** |
| 模型格式 | .model3.json (Live2D Cubism 3/4/5) | - |

> ⚠️ **重要**：pixi.js 和 pixi-live2d-display 的版本兼容性非常关键，必须使用上述指定版本！

---

## 样式方案说明

> **核心规则**：
> - **最外层** (`App.module.scss`)：使用 CSS Module，`className={styles.xxx}`
> - **内层组件** (`index.scss`)：与组件同级，用 `:global{}` 包裹，使用普通 className
> - **全局样式** (`global.scss`)：body、#root 等基础样式

```tsx
// App.tsx - 最外层使用 CSS Module
import styles from './App.module.scss';
<div className={styles.container}>
  <Live2DWidget />
</div>

// Live2DWidget/index.tsx - 内层使用普通 className + 导入样式
import './index.scss';
<div className="live2d-widget">
  <canvas className="live2d-canvas" />
</div>

// Live2DWidget/index.scss - 内层样式用 :global{} 包裹
:global {
  .live2d-widget { ... }
  .live2d-canvas { ... }
}
```

---

## 前置条件

Live2D Cubism SDK for Web 的 Core 文件已就位：
```
frontend/models/core/live2dcubismcore.js
```

---

## 实现步骤

### 步骤 1：安装依赖

```bash
cd frontend

# React 相关
npm install react react-dom
npm install -D @types/react @types/react-dom @vitejs/plugin-react

# Live2D 渲染（⚠️ 注意版本！）
npm install pixi.js@6 pixi-live2d-display@0.4.0

# 样式
npm install -D sass
```

---

### 步骤 2：修改配置文件

#### 2.1 vite.renderer.config.mts（新建，替换 .ts）

> ⚠️ **重要**：必须使用 `.mts` 扩展名，因为 `@vitejs/plugin-react` 是 ESM only

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  publicDir: 'models',  // 将 models 目录作为静态资源目录
});
```

#### 2.2 forge.config.ts

更新 vite 配置引用：

```typescript
renderer: [
  {
    name: 'main_window',
    config: 'vite.renderer.config.mts',  // 改为 .mts
  },
],
```

#### 2.3 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "commonjs",
    "allowJs": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "noImplicitAny": true,
    "sourceMap": true,
    "baseUrl": ".",
    "outDir": "dist",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "jsx": "react-jsx",
    "lib": ["ESNext", "DOM"]
  }
}
```

#### 2.4 index.html

```html
<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Desktop Pet</title>
    <script src="./models/core/live2dcubismcore.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

---

### 步骤 3：Electron 透明窗口配置

修改 `src/main.ts`：

```typescript
const mainWindow = new BrowserWindow({
  width: 600,             // 窗口宽度
  height: 750,            // 窗口高度
  transparent: true,      // 透明背景
  frame: false,           // 无边框
  alwaysOnTop: true,      // 始终置顶
  hasShadow: false,       // 无阴影
  resizable: false,
  webPreferences: {
    preload: path.join(__dirname, 'preload.js'),
    webSecurity: false,   // 允许加载本地文件（重要！）
  },
});
```

---

### 步骤 4：创建目录结构

```
frontend/src/
├── components/
│   └── Live2DWidget/
│       ├── index.tsx              # 主组件
│       ├── index.scss             # 组件样式（:global{} 包裹）
│       ├── Live2DCanvas.tsx       # Canvas 渲染组件
│       ├── useLive2DModel.ts      # 模型加载 Hook
│       └── useRandomExpression.ts # 随机表情 Hook
├── styles/
│   └── global.scss                # 全局样式（body、#root 等）
├── utils/
│   └── expressionManager.ts       # 表情管理工具
├── App.tsx                        # 根组件（使用 CSS Module）
├── App.module.scss                # 最外层样式
├── main.tsx                       # React 入口（无 StrictMode）
└── vite-env.d.ts                  # 类型声明
```

---

### 步骤 5：组件职责划分

| 组件/文件 | 职责 |
|-----------|------|
| `Live2DWidget/index.tsx` | 主容器，组合 Canvas 和控制逻辑 |
| `Live2DCanvas.tsx` | 负责 PIXI.js Canvas 初始化和渲染 |
| `useLive2DModel.ts` | 加载模型、管理模型实例 |
| `useRandomExpression.ts` | 随机表情定时器逻辑 |
| `expressionManager.ts` | 表情列表配置、随机选择算法 |

---

### 步骤 6：样式文件内容

#### 6.1 全局样式 (`styles/global.scss`)
```scss
:global {
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    background: transparent;
    margin: 0;
    overflow: hidden;
  }

  #root {
    width: 100vw;
    height: 100vh;
    background: transparent;
  }
}
```

#### 6.2 最外层样式 (`App.module.scss`)
```scss
.container {
  width: 100vw;
  height: 100vh;
  background: transparent;
}
```

#### 6.3 组件样式 (`components/Live2DWidget/index.scss`)
```scss
:global {
  .live2d-widget {
    width: 100%;
    height: 100%;
    position: relative;
    -webkit-app-region: drag;  // 允许拖动
    cursor: move;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .live2d-canvas {
    width: 100%;
    height: 100%;
  }
}
```

---

### 步骤 7：核心功能实现

#### 7.1 Live2D 模型加载 (`useLive2DModel.ts`)

> ⚠️ **关键**：必须从 `/cubism4` 路径导入，否则会尝试加载 Cubism 2 runtime

```typescript
import * as PIXI from 'pixi.js';
// 关键：必须从 /cubism4 路径导入
import { Live2DModel } from 'pixi-live2d-display/cubism4';

// 注册 Ticker（只需执行一次）
Live2DModel.registerTicker(PIXI.Ticker);

// 加载模型（路径根据 publicDir 配置调整）
const live2dModel = await Live2DModel.from('/jk-cat/jk盐.model3.json');

// ⚠️ 不要设置 autoInteract: false，否则模型不会跟随鼠标
```

#### 7.2 PIXI Application 初始化 (`Live2DCanvas.tsx`)

> ⚠️ **关键**：必须使用 `useState` 而不是 `useRef`，否则 hook 无法感知 app 已初始化

```typescript
import { useEffect, useRef, useState } from 'react';
import * as PIXI from 'pixi.js';

export function Live2DCanvas({ width = 600, height = 750 }: Live2DCanvasProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [app, setApp] = useState<PIXI.Application | null>(null);  // 用 useState！
  const initializedRef = useRef(false);

  useEffect(() => {
    if (!canvasRef.current || initializedRef.current) return;
    initializedRef.current = true;

    const pixiApp = new PIXI.Application({
      view: canvasRef.current,
      width,
      height,
      backgroundAlpha: 0,
      resolution: window.devicePixelRatio * 2 || 2,  // 提高清晰度
      autoDensity: true,
      antialias: true,
    });

    setApp(pixiApp);  // 触发重新渲染

    return () => {
      if (pixiApp) {
        pixiApp.destroy(true);
        setApp(null);
        initializedRef.current = false;
      }
    };
  }, [width, height]);

  // ...
}
```

#### 7.3 模型居中显示

```typescript
// 设置锚点在模型中心
live2dModel.anchor.set(0.5, 0.5);

// 计算缩放比例，适应窗口大小
const scale = Math.min(
  app.screen.width / live2dModel.width,
  app.screen.height / live2dModel.height
);
live2dModel.scale.set(scale * 0.9);  // 0.9 留一点边距

// 居中定位
live2dModel.x = app.screen.width / 2;
live2dModel.y = app.screen.height / 2;
```

#### 7.4 随机表情播放 (`useRandomExpression.ts`)

```typescript
import { getRandomExpression, getRandomInterval } from '../../utils/expressionManager';

export function useRandomExpression(model: Live2DModel | null) {
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (!model) return;

    const playRandomExpression = async () => {
      try {
        const expressionName = getRandomExpression();
        await model.expression(expressionName);
      } catch (err) {
        console.warn('Failed to play expression:', err);
      }
      timerRef.current = setTimeout(playRandomExpression, getRandomInterval());
    };

    timerRef.current = setTimeout(playRandomExpression, getRandomInterval());

    return () => {
      if (timerRef.current) {
        clearTimeout(timerRef.current);
      }
    };
  }, [model]);
}
```

---

## 文件修改清单

### 需要修改的文件

| 文件 | 修改内容 |
|------|----------|
| `package.json` | 添加 React、pixi@6、sass 依赖 |
| `vite.renderer.config.mts` | 新建，添加 React 插件和 publicDir 配置 |
| `forge.config.ts` | vite 配置引用改为 `.mts` |
| `tsconfig.json` | 添加 JSX 和 DOM lib 配置 |
| `src/main.ts` | 透明窗口配置（600x750） |
| `index.html` | 引入 Live2D Core，添加 root 容器 |

### 需要新增的文件

| 文件 | 说明 |
|------|------|
| `src/main.tsx` | React 入口（无 StrictMode） |
| `src/App.tsx` | 根组件（使用 CSS Module） |
| `src/App.module.scss` | 最外层 CSS Module 样式 |
| `src/styles/global.scss` | 全局样式（body、#root） |
| `src/components/Live2DWidget/index.tsx` | 主组件 |
| `src/components/Live2DWidget/index.scss` | 组件样式（:global{}） |
| `src/components/Live2DWidget/Live2DCanvas.tsx` | Canvas 渲染组件 |
| `src/components/Live2DWidget/useLive2DModel.ts` | 模型加载 Hook |
| `src/components/Live2DWidget/useRandomExpression.ts` | 随机表情 Hook |
| `src/utils/expressionManager.ts` | 表情管理工具 |
| `src/vite-env.d.ts` | CSS Module 类型声明 |

---

## 可用表情列表

| 文件名 | 描述 |
|--------|------|
| 脸红.exp3.json | 脸红 |
| 眼-星星眼.exp3.json | 星星眼 |
| 眼-爱心眼.exp3.json | 爱心眼 |
| 眼-哭哭.exp3.json | 哭泣 |
| 眼-生气.exp3.json | 生气 |
| 眼-泪眼汪汪.exp3.json | 泪眼汪汪 |
| 眼-眩晕流汗.exp3.json | 眩晕流汗 |
| 吐舌.exp3.json | 吐舌 |
| 脸黑.exp3.json | 脸黑 |
| 眼-平静死鱼眼.exp3.json | 死鱼眼 |

---

## 预期效果

1. 启动后显示透明窗口，只看到 Live2D 模型
2. 窗口可以在桌面任意位置拖拽移动
3. 模型眼睛/头部跟随鼠标移动
4. 每 5-10 秒随机切换表情
5. 窗口始终置顶
6. 不出现任何滚动条

---

## 核心功能实现要点

### 1. 桌面拖拽功能

拖拽功能需要 Electron 和 CSS 配合实现：

#### Electron 窗口配置 (`src/main.ts`)

```typescript
const mainWindow = new BrowserWindow({
  frame: false,           // 无边框（必须）
  transparent: true,      // 透明背景
  // ... 其他配置
});
```

#### CSS 拖拽区域 (`index.scss`)

```scss
:global {
  .live2d-widget {
    width: 100%;
    height: 100%;
    -webkit-app-region: drag;  // 关键：允许拖拽整个窗口
    cursor: move;
  }

  // 如果有交互元素（按钮等），需要禁用拖拽
  .interactive-element {
    -webkit-app-region: no-drag;
  }
}
```

> **原理**：`-webkit-app-region: drag` 告诉 Electron 该区域可以拖拽移动窗口

### 2. 背景透明

需要 Electron 和 CSS 双重配置：

#### Electron 窗口配置

```typescript
const mainWindow = new BrowserWindow({
  transparent: true,      // 窗口透明
  hasShadow: false,       // 禁用阴影（避免出现灰色边框）
  frame: false,           // 无边框
  // ...
});
```

#### CSS 样式配置 (`global.scss`)

```scss
:global {
  html, body {
    background: transparent !important;  // 强制透明
  }

  body {
    margin: 0;
    overflow: hidden;  // 防止内容溢出
  }

  #root {
    width: 100vw;
    height: 100vh;
    background: transparent;
  }
}
```

#### PIXI Canvas 透明

```typescript
const pixiApp = new PIXI.Application({
  backgroundAlpha: 0,  // 关键：透明背景
  // ...
});
```

### 3. 禁用滚动条

需要多层面配置：

#### HTML 配置 (`index.html`)

```html
<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <style>
      html, body {
        overflow: hidden;  /* 禁用滚动 */
      }
    </style>
  </head>
  <body>
    <!-- ... -->
  </body>
</html>
```

#### CSS 全局样式 (`global.scss`)

```scss
:global {
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    overflow: hidden;        /* 禁用滚动 */
    overflow-x: hidden;      /* 禁用横向滚动 */
    overflow-y: hidden;      /* 禁用纵向滚动 */
  }

  /* 隐藏滚动条（兼容性） */
  body::-webkit-scrollbar {
    display: none;
  }

  body {
    -ms-overflow-style: none;  /* IE/Edge */
    scrollbar-width: none;     /* Firefox */
  }
}
```

#### 组件样式 (`index.scss`)

```scss
:global {
  .live2d-widget {
    overflow: hidden;  // 组件内部也不滚动
  }
}
```

---

## 开发命令

```bash
cd frontend
npm install    # 安装依赖
npm start      # 开发模式运行
```

---

## 常见问题与解决方案

### 1. 依赖版本兼容性问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| `@vitejs/plugin-react` ESM 错误 | 该插件是 ESM only | 配置文件改为 `.mts` |
| `manager.on is not a function` | pixi.js v7 不兼容 | 使用 pixi.js@6 |
| `Could not find Cubism 2 runtime` | 默认加载 Cubism 2 | 从 `/cubism4` 导入 |

### 2. 模型不显示（无报错）

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| hook 始终收到 `app=null` | `useRef` 不触发重渲染 | 改用 `useState` |
| 模型路径 404 | models 不在静态资源路径 | 配置 `publicDir: 'models'` |

### 3. 模型模糊

| 原因 | 解决方案 |
|------|----------|
| 高 DPI 显示器 | 设置 `resolution: devicePixelRatio * 2` |
| 窗口太小 | 增大窗口尺寸到 600x750 |
| 抗锯齿未启用 | 设置 `antialias: true` |

### 4. 模型不跟随鼠标

| 原因 | 解决方案 |
|------|----------|
| 设置了 `autoInteract: false` | 移除该选项，保持默认 |

### 5. React + PIXI 注意事项

- **不要使用 `React.StrictMode`**（避免双重渲染导致 PIXI canvas 冲突）
- 使用 `useState` 而不是 `useRef` 存储 PIXI Application
- 正确处理 cleanup 函数

### 6. 窗口拖拽不生效

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 拖拽无反应 | 未设置 `-webkit-app-region: drag` | 在容器元素添加该 CSS 属性 |
| 整个窗口无法拖拽 | 交互元素覆盖了拖拽区域 | 确保拖拽区域在最上层 |
| 点击穿透 | 拖拽区域未设置 `cursor: move` | 添加 cursor 样式提示可拖拽 |

### 7. 背景不透明

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 窗口有白色背景 | body 或 #root 未设置透明 | 设置 `background: transparent` |
| 有灰色阴影 | `hasShadow: true` | 设置 `hasShadow: false` |
| PIXI 背景不透明 | `backgroundAlpha` 未设置 | 设置 `backgroundAlpha: 0` |

### 8. 出现滚动条

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 出现横向滚动条 | 内容超出窗口宽度 | 设置 `overflow-x: hidden` |
| 出现纵向滚动条 | 内容超出窗口高度 | 设置 `overflow-y: hidden` |
| 模型超出导致滚动 | Canvas 尺寸大于窗口 | 确保 Canvas 尺寸与窗口一致 |
| 默认 margin 导致滚动 | body 有默认 margin | 重置 `body { margin: 0 }` |
| 仍出现滚动条 | html/body 未占满高度或 canvas 默认 inline | 设置 `html, body { width: 100%; height: 100%; overflow: hidden; }` 并给 canvas 加 `display: block` |

---

## 风险与注意事项

1. **版本兼容性**：pixi.js 必须使用 v6，与 pixi-live2d-display@0.4.0 配合
2. **Cubism 版本**：使用 moc3 模型必须从 `/cubism4` 路径导入
3. **ESM/CJS 混用**：Vite 插件配置文件需要 `.mts` 扩展名
4. **CORS 问题**：本地文件加载需要配置 `webSecurity: false`
5. **模型路径**：配置 `publicDir` 后，路径从 `/models/xxx` 变为 `/xxx`
6. **性能**：高清纹理（8192）需要 GPU 资源，注意分辨率倍数不要过高
7. **表情过渡**：`pixi-live2d-display` 会自动处理表情过渡
8. **拖拽冲突**：如果有交互元素（按钮、输入框），需要在该元素上设置 `-webkit-app-region: no-drag`
9. **透明窗口**：Windows 系统可能需要在 `package.json` 中配置 `"win": { "target": "nsis" }` 以获得更好的透明效果
10. **滚动条隐藏**：需要同时在 html、body 和容器元素上设置 `overflow: hidden`
11. **开发环境差异**：开发模式下透明效果可能与生产环境不同，最终效果需以打包后为准
